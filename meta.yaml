package:
  name: fre-nctools
  version: alpha

source:
  path: .

build:
  number: 0

requirements:
  build:
    - conda-forge::nco
    - conda-forge::libnetcdf
    - conda-forge::netcdf-fortran
    - conda-forge::mpich
    - conda-forge::gfortran
    - conda-forge::python>2
    - conda-forge::numpy
    - conda-forge::pytest
    - conda-forge::libtool
    - conda-forge::autoconf
    - conda-forge::automake
    - conda-forge::hdf5=1.14.*=mpi*
    - conda-forge::openmp
    - conda-forge::tcsh
    - conda-forge::which
  run:

test:
  commands:
    - echo 'Testing FRE-NCtools conda package installation...'
    - echo "Environment check:" && pwd && ls -la && echo "PATH=$PATH"
    
    # Test key installed programs with help flags (allow help commands to exit with any status)
    - echo "Testing timavg script..." && which timavg && (timavg -h || echo "timavg help command completed")
    - echo "Testing ncexists program..." && which ncexists && (ncexists --help || echo "ncexists help command completed")
    - echo "Testing combine-ncc program..." && which combine-ncc && (combine-ncc --help || echo "combine-ncc help command completed")
    - echo "Testing fregrid program..." && which fregrid && (fregrid --help || echo "fregrid help command completed")
    - echo "Testing make_hgrid program..." && which make_hgrid && (make_hgrid --help || echo "make_hgrid help command completed")
    - echo "Testing check_mask program..." && which check_mask && (check_mask 2>&1 | grep -q "check_mask --grid_file" && echo "check_mask usage displayed correctly" || echo "check_mask found")
    
    # Test some key script utilities exist
    - echo "Testing list_ncvars.sh script..." && which list_ncvars.sh && echo "list_ncvars.sh found"
    - echo "Testing split_ncvars.pl script..." && which split_ncvars.pl && echo "split_ncvars.pl found"
    
    # Test version reporting for programs that support it (allow version commands to exit with any status)
    - echo "Testing version reporting..." && (ncexists --version || echo "ncexists version command completed")
    - echo "Testing combine-ncc version..." && (combine-ncc --version || echo "combine-ncc version command completed")  
    - echo "Testing timavg version..." && (timavg -V || echo "timavg version command completed")
    
    # Simple functional tests that don't require build infrastructure
    - echo "Creating simple test data..." && echo 'netcdf test { dimensions: time=2; x=2; variables: double time(time); time:units="days"; float data(time,x); data: time=1,2; data=10,20,30,40; }' > timtest.cdl
    - echo "Testing ncgen availability..." && ncgen -o timtest.nc timtest.cdl && test -f timtest.nc && echo "ncgen test PASSED"
    - echo "Testing timavg basic functionality..." && timavg -o timout.nc timtest.nc && test -f timout.nc && echo "timavg basic test PASSED"
    - echo "Testing ncdump on timavg output..." && ncdump -h timout.nc && echo "ncdump test PASSED"
    
    # Test ncexists functionality  
    - echo "Testing ncexists functionality..." && ncexists -f timtest.nc -v data && echo "ncexists variable test PASSED"
    - echo "Testing ncexists global attribute..." && ncexists -f timtest.nc -g Conventions || echo "ncexists global test completed (no global attr expected)"
    
    - echo 'All tests completed - FRE-NCtools installation verified!'

about:
  license: LGPL-3.0
  summary: Tools for manipulating and creating netCDF inputs for FMS managed models

package:
  name: fre-nctools
  version: alpha

source:
  path: .

build:
  number: 0

requirements:
  build:
    - conda-forge::nco
    - conda-forge::libnetcdf
    - conda-forge::netcdf-fortran
    - conda-forge::mpich
    - conda-forge::gfortran
    - conda-forge::python>2
    - conda-forge::numpy
    - conda-forge::pytest
    - conda-forge::libtool
    - conda-forge::autoconf
    - conda-forge::automake
    - conda-forge::hdf5=1.14.*=mpi*
    - conda-forge::openmp
    - conda-forge::tcsh
    - conda-forge::which
  run:

test:
  commands:
    - echo 'Testing FRE-NCtools conda package installation...'
    - echo "Installation directory:" && pwd && ls
    
    # Test key installed programs with help flags (allow help commands to exit with any status)
    - echo "Testing timavg script..." && which timavg && (timavg -h || echo "timavg help command completed")
    - echo "Testing ncexists program..." && which ncexists && (ncexists --help || echo "ncexists help command completed")
    - echo "Testing combine-ncc program..." && which combine-ncc && (combine-ncc --help || echo "combine-ncc help command completed")
    - echo "Testing fregrid program..." && which fregrid && (fregrid --help || echo "fregrid help command completed")
    - echo "Testing make_hgrid program..." && which make_hgrid && (make_hgrid --help || echo "make_hgrid help command completed")
    - echo "Testing check_mask program..." && which check_mask && (check_mask 2>&1 | grep -q "check_mask --grid_file" && echo "check_mask usage displayed correctly" || echo "check_mask found")
    
    # Test some key script utilities exist
    - echo "Testing list_ncvars.sh script..." && which list_ncvars.sh && echo "list_ncvars.sh found"
    - echo "Testing split_ncvars.pl script..." && which split_ncvars.pl && echo "split_ncvars.pl found"
    
    # Test version reporting for programs that support it (allow version commands to exit with any status)
    - echo "Testing version reporting..." && (ncexists --version || echo "ncexists version command completed")
    - echo "Testing combine-ncc version..." && (combine-ncc --version || echo "combine-ncc version command completed")  
    - echo "Testing timavg version..." && (timavg -V || echo "timavg version command completed")
    
    # Simple functional tests using one-line ncgen commands
    - echo "Testing combine-ncc functionality..." && echo 'netcdf compress1 { dimensions: lat=2; lon=2; lpt=2; variables: int lpt(lpt); float lst(lpt); float lat(lat); float lon(lon); data: lon=1,2; lat=1,2; lpt=1,4; lst=100,104; }' | ncgen -o compress1.nc && echo 'netcdf compress2 { dimensions: lat=2; lon=2; lpt=2; variables: int lpt(lpt); float lst(lpt); float lat(lat); float lon(lon); data: lon=1,2; lat=1,2; lpt=2,3; lst=200,300; }' | ncgen -o compress2.nc && combine-ncc compress1.nc compress2.nc combined.nc && test -f combined.nc && ncdump -h combined.nc && echo "combine-ncc functional test PASSED"
    
    - echo "Testing ncexists functionality..." && echo 'netcdf test { dimensions: x=2; variables: float temp(x); data: temp=1,2; }' | ncgen -o test_exist.nc && ncexists -f test_exist.nc -v temp && echo "ncexists functional test PASSED"
    
    # Simple timavg test - create a file with time dimension and test timavg  
    - echo "Testing timavg functionality..." && echo 'netcdf timtest { dimensions: time=2; x=2; variables: double time(time); float data(time,x); data: time=1,2; data=10,20,30,40; }' | ncgen -o timtest.nc && timavg -o timout.nc timtest.nc && test -f timout.nc && ncdump -h timout.nc && echo "timavg functional test PASSED"
    
    - echo 'All tests completed - FRE-NCtools installation verified!'

about:
  license: LGPL-3.0
  summary: Tools for manipulating and creating netCDF inputs for FMS managed models
